{% extends layout %}

{% set selector = '#pg-aovivo' %}

{% block main %}

    <div class="page-title">
        <h3 class="title">Jogos Ao Vivo</h3>
    </div>

    <div id="pg-aovivo">
        <div class="container-fluid pt-3">
            <div class="row">
                <div class="col">
                    <div class="mb-3">
                        {% include 'website/inc/slideshow.twig' with {ref: 'site-slideshow'} %}
                    </div>
                    <div class="live-list" v-if="dadosCarregados">
                        <div v-if="!paises || !paises.length" class="alert alert-info">
                            Nenhum jogo ao vivo no momento.
                        </div>

                        <div v-for="pais in paises" class="mb-4" v-if="pais.campeonatos && pais.campeonatos.length">
                            <div class="d-flex align-items-center mb-2">
                                <img v-bind:src="pais.img" alt="" style="height: 18px; width: auto; margin-right: 8px;">
                                <strong>${pais.title}</strong>
                            </div>
                            <div v-for="campeonato in pais.campeonatos" class="card mb-3">
                                <div class="card-header py-2">
                                    <strong>${campeonato.title}</strong>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <tbody>
                                        <tr v-for="jogo in campeonato.jogos">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge badge-danger mr-2">AO VIVO</span>
                                                    <div>
                                                        <div class="team-line">
                                                            <img v-bind:src="teamLogoUrl(jogo.casa)" class="team-logo" v-on:error="onLogoError">
                                                            <b class="text-truncate">${jogo.casa}</b>
                                                            <span class="mx-1">x</span>
                                                            <img v-bind:src="teamLogoUrl(jogo.fora)" class="team-logo" v-on:error="onLogoError">
                                                            <b class="text-truncate">${jogo.fora}</b>
                                                        </div>
                                                        <small class="text-muted">${jogo.data.split('-').reverse().join('/')} ${jogo.hora.replace(/:00$/, '')}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td width="1">
                                                <div class="h5 m-0">
                                                    ${(jogo.placar && jogo.placar.casa != null) ? jogo.placar.casa : '-'}
                                                    :
                                                    ${(jogo.placar && jogo.placar.fora != null) ? jogo.placar.fora : '-'}
                                                </div>
                                            </td>
                                            <td width="1" class="text-center">
                                                <div class="btn-cotacao outras"
                                                     title="Outras cotações"
                                                     v-on:click="maisCotacoes(jogo)">
                                                    +${outrosCount(jogo)}
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {{ block('modal') }}

        {{ block('bilhete') }}
    </div>

{% endblock %}

{% block bilhete %}
    {% include 'website/inc/bilhete-sidebar.twig' %}
{% endblock %}

{% block script %}

    <script src="node_modules/vue/dist/vue.min.js"></script>
    <script src="node_modules/axios/dist/axios.js"></script>

    <style>
        .team-logo{
            width: 18px;
            height: 18px;
            object-fit: contain;
            margin-right: 6px;
        }
        .team-line{
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
        }
        .team-line .mx-1{ margin: 0 6px; }
    </style>

    <script type="text/javascript">
        window.appLive = new Vue({
            el: '{{ selector }}',
            delimiters: ['${', '}'],
            created() {
                $('html').addClass('loading');
                axios
                    .get('{{ url("aovivo/jogos") }}')
                    .then(({data}) => {
                        this.paises = data.paises || [];
                        this.grupos = data.grupos || {};
                        this.cotacoes = data.cotacoes || [];
                        this.dadosCarregados = true;
                    })
                    .catch(() => {
                        this.dadosCarregados = true;
                    })
                    .then(() => {
                        $('html').removeClass('loading');
                    });
            },
            data() {
                return {
                    dadosCarregados: false,
                    paises: [],
                    grupos: {},
                    cotacoes: [],
                    tempos: {90: 'Jogo completo', pt: 'Primeiro tempo', st: 'Segundo tempo'},
                    mJogo: { jogo: null, tempo: 90 },

                    // Dados para o bilhete (mesmos nomes do apostar.twig)
                    valorAposta: {{ apostaMinima }},
                    aposta: {
                        jogos: [],
                    },
                    cotacaoMaxima: {{ cotacaoMaxima ?: 99999999 }},
                    cotacaoMinima: {{ cotacaoMinima ?: 1 }},
                    condicaoCotacao: {{ condicaoCotacao|json_encode|raw }},
                    apostaMinima: {{ apostaMinima ?: 1 }},
                    apostaMaxima: {{ apostaMaxima ?: 999999 }},
                    retornoMaximo: {{ retornoMaximo ?: 99999999 }},
                    minJogos: {{ minJogos ?: 1 }},
                }
            },
            filters: {
                maskReal(value) {
                    if (!value) {
                        return '0,00';
                    } else {
                        return value.toString().toReal();
                    }
                }
            },
            computed: {
                cotacao() { return this.getCotacao(); },
                premio() { return this.getPremio().toString().toReal(); },
                apostaValida() {
                    if ((this.aposta.jogos || []).length >= this.minJogos) {
                        return this.getCotacao() >= this.getCotacaoMinima();
                    }
                    return false;
                },
            },
            methods: {
                isSelecionada(jogo, tempo, campo) {
                    try {
                        const keyTempo = '' + tempo;
                        return (this.aposta.jogos || []).some(v => v && v.jogo && v.jogo.id == jogo.id && ('' + v.tempo) === keyTempo && v.cotacao && v.cotacao.campo === campo);
                    } catch (e) { return false; }
                },
                findApostaIndex(jogo, tempo, campo) {
                    try {
                        const keyTempo = '' + tempo;
                        return (this.aposta.jogos || []).findIndex(v => v && v.jogo && v.jogo.id == jogo.id && ('' + v.tempo) === keyTempo && v.cotacao && v.cotacao.campo === campo);
                    } catch (e) { return -1; }
                },
                updateOutrasFlag(jogo) {
                    try {
                        const hasOutras = (this.aposta.jogos || []).some(v => v && v.jogo && v.jogo.id == jogo.id && (v.cotacao && v.cotacao.principal != '1' || ('' + v.tempo) !== '90'));
                        jogo.outras = !!hasOutras;
                    } catch (e) { jogo.outras = false; }
                },
                teamSlug(name) {
                    try {
                        return (name || '')
                            .toString()
                            .toLowerCase()
                            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                            .replace(/[^a-z0-9]+/g, '-')
                            .replace(/(^-+|-+$)/g, '');
                    } catch (e) { return ''; }
                },
                teamLogoUrl(name) {
                    const s = this.teamSlug(name);
                    const n = s.replace(/-/g, '');
                    const countryMap = {
                        'brasil':'br','brazil':'br',
                        'argentina':'ar',
                        'venezuela':'ve',
                        'australia':'au','australiaw':'au',
                        'mexico':'mx','méxico':'mx',
                        'portugal':'pt',
                        'espanha':'es','spain':'es',
                        'franca':'fr','france':'fr',
                        'italia':'it','italy':'it',
                        'alemanha':'de','germany':'de',
                        'inglaterra':'gb-eng','england':'gb-eng',
                        'estadosunidos':'us','eua':'us','usa':'us','unitedstates':'us',
                        'japao':'jp','japan':'jp',
                        'coreiadosul':'kr','southkorea':'kr',
                        'uruguai':'uy','uruguay':'uy',
                        'paraguai':'py','paraguay':'py',
                        'chile':'cl',
                        'colombia':'co',
                        'peru':'pe',
                        'equador':'ec','ecuador':'ec',
                        'bolivia':'bo','bolívia':'bo',
                        'canada':'ca','canadá':'ca',
                        'granada':'gd',
                        'ilhasvirgenseua':'vi','virginislandsus':'vi'
                    };
                    if (countryMap[n]) {
                        return 'https://flagcdn.com/24x18/' + countryMap[n] + '.png';
                    }
                    return s ? ('img/teams/' + s + '.png') : '';
                },
                onLogoError(ev) {
                    try { if (ev && ev.target) ev.target.style.display = 'none'; } catch (e) {}
                },
                countMappedForTempo(jogo, tempo) {
                    try {
                        const odds = (jogo && jogo.cotacoes && jogo.cotacoes[tempo]) || {};
                        let total = 0;
                        (this.cotacoes || []).forEach((c) => {
                            const v = odds[c.campo];
                            if (v && v > 1) total++;
                        });
                        return total;
                    } catch (e) { return 0; }
                },
                outrosCount(jogo) {
                    try {
                        const tempo = '90';
                        const odds = (jogo && jogo.cotacoes && jogo.cotacoes[tempo]) || {};
                        // itens configurados
                        let total = this.countMappedForTempo(jogo, tempo);
                        // placar exato (cs_h_a)
                        Object.keys(odds).forEach((k) => {
                            if (/^cs_\d+_\d+$/.test(k) && odds[k] > 1) total++;
                        });
                        // subtrai 1x2 se presentes
                        ['casa','empate','fora'].forEach(k => { if (odds[k] > 1) total--; });
                        return total > 0 ? total : '';
                    } catch (e) { return ''; }
                },
                maisCotacoes(jogo) {
                    this.mJogo.jogo = jogo;
                    this.mJogo.tempo = 90;
                    // Atualiza odds ao abrir
                    const params = new URLSearchParams({ jogo: jogo.id });
                    axios
                        .get(url('apostar/odds') + '?' + params.toString())
                        .then(({data}) => {
                            const live = (data && data.cotacoes) || {};
                            if (!this.mJogo.jogo.cotacoes) this.mJogo.jogo.cotacoes = {};
                            Object.keys(live).forEach((tempo) => {
                                if (!this.mJogo.jogo.cotacoes[tempo] || typeof this.mJogo.jogo.cotacoes[tempo] !== 'object') {
                                    this.$set(this.mJogo.jogo.cotacoes, tempo, {});
                                }
                                const mercados = live[tempo] || {};
                                Object.keys(mercados).forEach((campo) => {
                                    this.$set(this.mJogo.jogo.cotacoes[tempo], campo, mercados[campo]);
                                });
                            });
                        })
                        .catch(() => {})
                        .then(() => $('#modal-cotacoes-live').modal('show'));
                },
                listPlacarExato() {
                    try {
                        const tempo = this.mJogo.tempo + '';
                        const odds = (this.mJogo.jogo && this.mJogo.jogo.cotacoes && this.mJogo.jogo.cotacoes[tempo]) || {};
                        const items = [];
                        const rex = /^cs_(\d+)_(\d+)$/;
                        Object.keys(odds).forEach((campo) => {
                            const v = odds[campo];
                            if (v <= 1) return;
                            const m = campo.match(rex);
                            if (!m) return;
                            const h = parseInt(m[1], 10), a = parseInt(m[2], 10);
                            items.push({
                                campo,
                                title: `Resultado exato ${h}:${a}`,
                                sigla: `CS ${h}:${a}`
                            });
                        });
                        items.sort((a,b) => {
                            const [ah,aa] = a.campo.replace('cs_','').split('_').map(n=>parseInt(n,10));
                            const [bh,ba] = b.campo.replace('cs_','').split('_').map(n=>parseInt(n,10));
                            if (ah === bh) return aa - ba;
                            return ah - bh;
                        });
                        return items;
                    } catch (e) { return []; }
                },

                // Seleciona/deseleciona uma odd (1 por jogo)
                apostar(jogo, tempo, cotacao) {
                    try {
                        const keyTempo = '' + tempo;
                        const apostaEm = keyTempo + cotacao.campo;

                        // Remove seleções anteriores deste jogo
                        for (let i = (this.aposta.jogos || []).length - 1; i >= 0; i--) {
                            const v = this.aposta.jogos[i];
                            if (v && v.jogo && v.jogo.id == jogo.id) {
                                this.aposta.jogos.splice(i, 1);
                            }
                        }

                        // Toggle: mesma seleção => desmarca
                        if (jogo.apostaEm === apostaEm) {
                            jogo.apostaEm = null;
                            jogo.outras = false;
                            return;
                        }

                        // Aplica nova seleção (1 por jogo)
                        jogo.apostaEm = apostaEm;
                        jogo.outras = !(cotacao.principal == '1' && keyTempo === '90');

                        this.aposta.jogos.push({
                            jogo: jogo,
                            tempo: keyTempo,
                            cotacao: cotacao,
                        });

                        $('#modal-cotacoes-live').modal('hide');
                    } catch (e) {}
                },

                // ===== Bilhete (mesma lógica essencial do apostar.twig) =====
                getCotacao() {
                    try {
                        let cotacao = 1;
                        (this.aposta.jogos || []).forEach((v) => {
                            cotacao *= v.jogo.cotacoes[v.tempo][v.cotacao.campo];
                        });
                        return parseFloat(Math.min(cotacao, this.cotacaoMaxima));
                    } catch (e) { return 1; }
                },
                getCotacaoMinima() {
                    let cotacaoMinima = this.cotacaoMinima;
                    const valorAposta = this.valorAposta;
                    (this.condicaoCotacao || []).forEach((value) => {
                        if ((value.min > 0 || value.max > 0) && value.cotacao > 0) {
                            if (value.min <= valorAposta && value.max >= valorAposta) {
                                cotacaoMinima = value.cotacao;
                            }
                        }
                    });
                    return cotacaoMinima;
                },
                getPremio() {
                    const valorAposta = this.valorAposta;
                    const cotacao = this.getCotacao();
                    if (cotacao > 1) {
                        return Math.min(valorAposta * cotacao, this.retornoMaximo);
                    } else {
                        return 0;
                    }
                },
                rmAposta(index) {
                    const aposta = this.aposta.jogos[index];
                    if (aposta) {
                        aposta.jogo.apostaEm = null;
                        aposta.jogo.outras = false;
                        this.aposta.jogos.splice(index, 1);
                    }
                },
                limpaAposta() {
                    (this.aposta.jogos || []).forEach((j) => {
                        if (!j || !j.jogo) return;
                        j.jogo.apostaEm = null;
                        j.jogo.outras = false;
                    });
                    this.aposta.jogos = [];
                    $(".bilhete").removeClass('show');
                },
                finalizarAposta() {
                    const aposta = {
                        valor: this.valorAposta,
                        cliente: '',
                        telefone: '',
                        revendedor: '',
                        jogos: [],
                    };
                    (this.aposta.jogos || []).forEach((v) => {
                        if (!v || !v.jogo) return;
                        aposta.jogos.push({
                            jogo: v.jogo.id,
                            tempo: v.tempo,
                            cotacao: v.cotacao.campo,
                            valor: parseFloat((v.jogo.cotacoes && v.jogo.cotacoes[v.tempo] && v.jogo.cotacoes[v.tempo][v.cotacao.campo]) || 0),
                        });
                    });
                    $('html').addClass('loading').removeClass('show-bilhete');
                    axios
                        .post(url('apostar/apostar'), aposta)
                        .then((response) => {
                            var e = response.data || {};
                            if (e.result == 1) {
                                this.limpaAposta();
                                this.valorAposta = this.apostaMinima;
                                window.localStorage.removeItem('apostaJogos');
                                if (e.codigo) {
                                    swal({
                                        title: $.trim(e.codigo.replace(/(.{3})/g, '$1 ')),
                                        text: 'Bilhete gerado com sucesso!\nProcure um dos nossos cambistas para validar o seu bilhete.',
                                        icon: 'success',
                                        button: {
                                            text: 'Compartilhar whatsapp',
                                            closeModal: true,
                                            value: {link: e.link, share: e.share},
                                        }
                                    }).then((e) => { window.open(e.share, '_blank'); });
                                } else {
                                    swal('Sucesso', 'Aposta realizada com sucesso!', 'success');
                                }
                            } else {
                                swal('Aviso!', e.message || 'Não foi possível concluir a aposta.', 'warning');
                            }
                        })
                        .catch(() => {})
                        .then(() => { $('html').removeClass('loading'); });
                },
            }
        });
    </script>

{% endblock %}

{% block modal %}
    <div id="modal-cotacoes-live" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-uppercase">Mais cotações</h5>
                    <div class="close" data-dismiss="modal">&times;</div>
                </div>
                <div class="modal-body p-0">
                    <div class="p-3">
                        <button type="button" class="btn btn-danger btn-sm mr-1"
                                v-bind:class="{active: key == mJogo.tempo || null}"
                                v-for="(tempo, key) in tempos" v-on:click="mJogo.tempo = key">
                            <span class="d-md-block d-none">${tempo}</span>
                            <span class="text-uppercase d-block d-md-none">${key}</span>
                        </button>
                    </div>

                    <table class="table table-minified table-striped table-bordered m-0">
                        <thead>
                        <tr class="bg-danger text-white">
                            <th>Descrição</th>
                            <th width="75">Taxa</th>
                        </tr>
                        </thead>
                    </table>

                    <div class="table-responsive m-0" v-if="mJogo.jogo"
                         style="max-height: calc(100vh - 63px - 63px - 70px); border-radius: 0 0 4px 4px;">

                        <table class="table table-minified table-striped table-bordered table-hover m-0"
                               v-for="(grupo, id) in grupos">
                            <thead>
                            <tr style="background-color: #bbb">
                                <th colspan="2">${grupo}</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="c in cotacoes"
                                v-if="c.grupo == id && mJogo.jogo.cotacoes[mJogo.tempo] && mJogo.jogo.cotacoes[mJogo.tempo][c.campo] > 1">
                                <td>${c.title}</td>
                                <td class="text-center py-1 px-2" width="5">
                                    <a href="javascript:;" class="btn btn-warning btn-cotacao"
                                       v-bind:class="{active: isSelecionada(mJogo.jogo, mJogo.tempo, c.campo)}"
                                       v-on:click="apostar(mJogo.jogo, mJogo.tempo, c)">
                                        ${mJogo.jogo.cotacoes[mJogo.tempo][c.campo]|maskReal}
                                    </a>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- Placar exato (dinâmico por período) -->
                        <table class="table table-minified table-striped table-bordered m-0"
                               v-if="listPlacarExato().length">
                            <thead>
                            <tr style="background-color: #bbb">
                                <th colspan="2">Placar exato — ${tempos[mJogo.tempo]}</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="item in listPlacarExato()">
                                <td>${item.title}</td>
                                <td class="text-center py-1 px-2" width="5">
                                    <a href="javascript:;" class="btn btn-warning btn-cotacao"
                                       v-bind:class="{active: isSelecionada(mJogo.jogo, mJogo.tempo, item.campo)}"
                                       v-on:click="apostar(mJogo.jogo, mJogo.tempo, {campo: item.campo, title: item.title, sigla: item.sigla, grupo: 4, principal: '0'})">
                                        ${mJogo.jogo.cotacoes[mJogo.tempo][item.campo]|maskReal}
                                    </a>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                    </div>

                </div>
            </div>
        </div>
    </div>
{% endblock %}
