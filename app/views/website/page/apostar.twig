{% extends layout %}

{% set hoje = 'now'|date('Y-m-d') %}
{% set amanha = '+1day'|date('Y-m-d') %}
{% set selector = '#website' %}

{% block bilhete %}
    {% include 'website/inc/bilhete-sidebar.twig' %}
{% endblock %}

{% block jogos %}

    <div class="table-responsive overflow-jogos" v-if="dadosCarregados && paises && paises.length">
        <table class="table table-jogos table-striped table-hover" v-for="pais in paises"
               v-if="filterPais(pais)">
            <thead>
            <tr class="tr-header">
                <th>Jogos</th>
                <th class="th-cotacao" v-for="c in getCotacoesPrincipais()">
                    <div v-bind:title="c.title" data-toggle="tooltip">
                        ${c.title}
                    </div>
                </th>
                <th class="th-cotacao">Outras</th>
            </tr>
            <tr class="tr-pais">
                <th colspan="10">
                    <img v-bind:src="pais.img"/> ${pais.title}
                </th>
            </tr>
            </thead>

            <tbody v-for="campeonato in getCampeonatos(pais, true)">

            <tr class="campeonato">
                <td colspan="10">
                    <a href="javascript:;" v-on:click="setCampeonato(campeonato)">${campeonato.title}</a>
                </td>
            </tr>

            <tr v-for="jogo in getJogos(campeonato)" v-if="jogo && jogo.casa && jogo.fora">
                <td>
                    <div v-on:click="maisCotacoes(jogo)" class="pointer">
                        <div class="text-truncate team-line">
                            <img v-bind:src="teamLogoUrl(jogo.casa)" class="team-logo" v-on:error="onLogoError">
                            <b class="text-truncate">${jogo.casa}</b>
                            <span class="mx-1">x</span>
                            <img v-bind:src="teamLogoUrl(jogo.fora)" class="team-logo" v-on:error="onLogoError">
                            <b class="text-truncate">${jogo.fora}</b>
                        </div>
                        <small>${jogo.data.split('-').reverse().join('/')} às ${jogo.hora.replace(/:00$/, '')}</small>
                    </div>
                </td>
                <td class="text-center" v-for="c in getCotacoesPrincipais()">
                    <div v-if="has1x2(jogo) && jogo.cotacoes && jogo.cotacoes['90'] && parseFloat(jogo.cotacoes['90'][c.campo]) > 1"
                         class="btn-cotacao"
                         v-bind:class="{active: jogo.apostaEm == '90' + c.campo}"
                         v-bind:title="c.title"
                         data-toggle="tooltip"
                         v-on:click="apostar(jogo, '90', c)">
                        ${jogo.cotacoes['90'][c.campo]|maskReal}
                    </div>
                    <div v-else class="btn-cotacao outras"
                         title="Outras cotações"
                         v-on:click="maisCotacoes(jogo)">
                        <span v-text="outrosCount(jogo)"></span>
                    </div>
                </td>
                <td>
                    <div class="btn-cotacao outras"
                         data-toggle="tooltip"
                         title="Outras cotações"
                         v-bind:class="{active: jogo.outras}"
                         v-on:click="maisCotacoes(jogo)">
                        <span v-text="outrosCount(jogo)"></span>
                    </div>
                </td>
            </tr>

            </tbody>

        </table>
    </div>

    {{ block('modalCotacoes') }}

{% endblock %}

{% block modalCotacoes %}
    <div id="modal-cotacoes" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-uppercase">Mais cotações</h5>
                    <div class="close" data-dismiss="modal">&times;</div>
                </div>
                <div class="modal-body p-0">
                    <div class="p-3">
                        <button type="button" class="btn btn-danger btn-sm mr-1"
                                v-bind:class="{active: key == mJogo.tempo || null}"
                                v-for="(tempo, key) in tempos" v-on:click="mJogo.tempo = key">
                            <span class="d-md-block d-none">${tempo}</span>
                            <span class="text-uppercase d-block d-md-none">${key}</span>
                        </button>
                    </div>

                    <table class="table table-minified table-striped table-bordered m-0">
                        <thead>
                        <tr class="bg-danger text-white">
                            <th>Descrição</th>
                            <th width="75">Taxa</th>
                        </tr>
                        </thead>
                    </table>

                    <div class="table-responsive m-0" v-if="mJogo.jogo"
                         style="max-height: calc(100vh - 63px - 63px - 70px); border-radius: 0 0 4px 4px;">

                        <table class="table table-minified table-striped table-bordered table-hover m-0"
                               v-for="(grupo, id) in grupos">
                            <thead>
                            <tr style="background-color: #bbb">
                                <th colspan="2">${grupo}</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="c in cotacoes"
                                v-if="c.grupo == id && mJogo.jogo.cotacoes[mJogo.tempo][c.campo] > 1">
                                <td>${c.title}</td>
                                <td class="text-center py-1 px-2" width="5">
                                    <a href="javascript:;" class="btn btn-warning btn-cotacao"
                                       v-bind:class="{active: mJogo.jogo.apostaEm == mJogo.tempo + c.campo }"
                                       v-on:click="apostar(mJogo.jogo, mJogo.tempo, c)">
                                        ${mJogo.jogo.cotacoes[mJogo.tempo][c.campo]|maskReal}
                                    </a>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- Placar exato (dinâmico por período) -->
                        <table class="table table-minified table-striped table-bordered table-hover m-0"
                               v-if="listPlacarExato().length">
                            <thead>
                            <tr style="background-color: #bbb">
                                <th colspan="2">Placar exato — ${tempos[mJogo.tempo]}</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="item in listPlacarExato()">
                                <td>${item.title}</td>
                                <td class="text-center py-1 px-2" width="5">
                                    <a href="javascript:;" class="btn btn-warning btn-cotacao"
                                       v-on:click="apostar(mJogo.jogo, mJogo.tempo, {campo: item.campo, title: item.title, sigla: item.sigla, grupo: 4, principal: '0'})">
                                        ${mJogo.jogo.cotacoes[mJogo.tempo][item.campo]|maskReal}
                                    </a>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                    </div>

                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block main %}

    <style>
        /* Igual ao Ao Vivo: número amarelo sobre fundo preto */
        .btn-cotacao.outras,
        .btn-cotacao.outras *,
        .table-jogos .btn-cotacao.outras{
            color: #ffc107 !important;
            font-weight: 700 !important;
        }
        /* Garante o mesmo visual do Ao Vivo também no tema claro */
        .table-jogos .btn-cotacao.outras{
            background: #000 !important;
            border-color: #000 !important;
        }
        .table-jogos .btn-cotacao.outras:hover{
            background: #000 !important;
            color: #ffc107 !important;
        }
    </style>

    <style>
        /* Logos dos times — tamanho fixo para não lesionar o layout */
        .team-logo{
            width: 18px;
            height: 18px;
            object-fit: contain;
            margin-right: 6px;
        }
        .team-line{
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
        }
        .team-line .mx-1{ margin: 0 6px; }
    </style>

    <div class="page-title">
        <h3 class="title">Faça já sua aposta</h3>
    </div>

    <div id="pg-aposta">
        <div class="container-fluid pt-3">
            <div class="row page-aposta">
                <div class="{{ responsive ? 'd-none d-md-block col-12 col-md-auto' : 'col-auto' }} mb-3">
                    <div style="max-height: 760px; overflow: auto">
                        <div class="campeonatos rounded">
                            <h3 class="title">DATAS</h3>
                            <ul>
                                <li>
                                    <a href="javascript:;" v-on:click="setCampeonato()"
                                       v-bind:class="{ active: !checkFiltros() }">
                                        <i class="fa fa-angle-right"></i> Todos os jogos
                                    </a>
                                </li>
                                <li v-for="(data, index) in datasProximos7Dias" v-bind:key="index">
                                    <a href="javascript:;" v-on:click="setData(data.valor)"
                                       v-bind:class="{ active: findData == data.valor }">
                                        ${data.diaSemana} (${data.formatada})
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="mb-3">
                        {% include 'website/inc/slideshow.twig' with {ref: 'site-slideshow'} %}
                    </div>
                    <div class="row">
                        <div class="col mb-3">

                            {% if responsive %}
                                <div class="d-block d-md-none mb-3">
                                    <ul class="opcoes-responsivo">
                                        <!--<li>
                                            <a href="javascript:;" v-on:click="setCampeonato()"
                                               v-bind:class="{ active: !checkFiltros() }">
                                                Todos
                                            </a>
                                        </li>
                                       <li>
                                            <a href="javascript:;" v-on:click="setData('{{ hoje }}')"
                                               v-bind:class="{ active: findData == '{{ hoje }}' }">
                                                Jogos de hoje ({{ hoje|split('-')|reverse|join('/') }})
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;" v-on:click="setData('{{ amanha }}')"
                                               v-bind:class="{ active: findData == '{{ amanha }}' }">
                                                Jogos de amanhã ({{ amanha|split('-')|reverse|join('/') }})
                                            </a>
                                        </li>-->
                                        <li>
                                            <label>Procurar</label>
                                        <div class="col-12 col-md">
                                            <input type="text" v-model="search" class="form-control form-control-sm"
                                                   placeholder="Pesquisar time, data ou campeonato..."/>
                                            <div class="d-block d-md-none mb-3"></div>
                                        </div>
                                        </li>
                                        <li>
                                            <label>Campeonatos</label>
                                            <select v-model="findCampeonato" class="form-control">
                                                <option value="*">Todos</option>
                                                <optgroup v-for="p in paises" v-bind:label="p.title">
                                                    <option v-for="c in p.campeonatos" v-bind:value="c.id">${c.title}
                                                    </option>
                                                </optgroup>
                                            </select>
                                        </li>
                                        <li>
                                            <label>País</label>
                                            <select v-model="findPais" class="form-control" v-on:change="onPaisChange">
                                                <option value="*">Todos</option>
                                                <option v-for="p in paises" v-bind:value="p.id">${p.title}</option>
                                            </select>
                                        </li>
                                        <li>
                                            <label style="display:block;">Filtro rápido</label>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="chkBrasil" v-model="somenteBrasil" v-on:change="onToggleBrasil">
                                                <label class="form-check-label" for="chkBrasil">Somente Brasil</label>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            {% endif %}

                            {{ block('jogos') }}

                        </div>
                        <div class="{{ responsive ? 'col-12' : '' }} bilhete-col mb-3">
                            {{ block('bilhete') }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block script %}

    <script src="node_modules/vue/dist/vue.min.js"></script>
    <script src="node_modules/axios/dist/axios.js"></script>
    <script src="node_modules/lodash/lodash.min.js"></script>

    <script type="text/javascript">

        window.app = new Vue({
            el: '{{ selector|default('#pg-aposta') }}',
            delimiters: ['${', '}'],
            created() {

                $('html').addClass('loading');

                // Gerar próximos 7 dias
                this.gerarProximos7Dias();

                this.aposta.jogos = this.aposta.jogos.filter((v) => {
                    return v && v.jogo && this.filterJogo(v.jogo);
                });

                const baseUrl = url('apostar/jogos');
                const qs = new URLSearchParams(window.location.search || '');
                const paisParam = qs.get('pais');
                // Ignora filtros não numéricos vindos da URL (ex.: ?pais=BR)
                if (paisParam && /^[0-9]+$/.test(paisParam)) {
                    this.findPais = parseInt(paisParam);
                } else {
                    this.findPais = '*';
                    this.somenteBrasil = false;
                }

                let fetchUrl = baseUrl;
                if (paisParam && paisParam !== '*') {
                    fetchUrl = baseUrl + '?pais=' + encodeURIComponent(paisParam);
                }

                axios
                    .get(fetchUrl)
                    .then((response) => {
                        this.grupos = response.data.grupos || {};
                        this.cotacoes = response.data.cotacoes || [];
                        this.paises = response.data.paises || [];
                        this.datas = response.data.datas || {};
                        this.dadosCarregados = true;
                        // Após renderizar a lista, pré-carrega a contagem de \"outras cotações\"
                        // para cada jogo visível, evitando depender apenas do hover.
                        this.$nextTick(() => {
                            try {
                                this.queueOutrosCounts();
                            } catch (e) {
                                console.warn('Falha ao pré-carregar outros mercados', e);
                            }
                        });
                    })
                    .catch((error) => {
                        console.error('Erro ao carregar jogos:', error);
                        this.dadosCarregados = true;
                    })
                    .then(() => {
                        $('html').removeClass('loading');
                        $(window).resize();
                    });

            },
            data() {
                return {
                    dadosCarregados: false,
                    valorAposta: {{ apostaMinima }},
                    findCampeonato: '*',
                    search: '',
                    findData: null,
                    findPais: '*',
                    tempos: {90: 'Jogo completo', pt: 'Primeiro tempo', st: 'Segundo tempo'},
                    cliente: '',
                    telefone: '',
                    revendedor: '',
                    grupos: {},
                    auth: {
                        username: '',
                        password: '',
                    },
                    datas: {},
                    datasProximos7Dias: [],
                    mJogo: {
                        jogo: null,
                        tempo: 90,
                    },
                    cotacoes: [],
                    paises: [],
                    aposta: {
                        jogos: [],
                    },
                    cotacaoMaxima: {{ cotacaoMaxima ?: 99999999 }},
                    cotacaoMinima: {{ cotacaoMinima ?: 1 }},
                    condicaoCotacao: {{ condicaoCotacao|json_encode|raw }},
                    apostaMinima: {{ apostaMinima ?: 1 }},
                    apostaMaxima: {{ apostaMaxima ?: 999999 }},
                    retornoMaximo: {{ retornoMaximo ?: 99999999 }},
                    minJogos: {{ minJogos ?: 1 }},
                    somenteBrasil: false,
                    somenteComOdds: false,
                    loadingOddsFilter: false,
                };
            },
            filters: {
                maskReal(value) {
                    if (!value) {
                        return '0,00';
                    } else {
                        return value.toString().toReal();
                    }
                }
            },
            computed: {
                cotacao() {
                    return this.getCotacao();
                },
                premio() {
                    return this.getPremio().toString().toReal();
                },
                premioRevenda() {
                    return (this.getPremio() * (100 - {{ premioRevenda|default(0) }}) / 100).toString().toReal();
                },
                valorCotacao() {
                    return this.getCotacao().toString().toReal();
                },
                apostaValida() {
                    if (this.aposta.jogos.length >= this.minJogos) {
                        if (this.getCotacao() >= this.getCotacaoMinima()) {
                            return true;
                        }
                    }
                    return false;
                },
            },
            watch: {
            },
            methods: {
                teamSlug(name) {
                    try {
                        return (name || '')
                            .toString()
                            .toLowerCase()
                            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                            .replace(/[^a-z0-9]+/g, '-')
                            .replace(/(^-+|-+$)/g, '');
                    } catch (e) { return ''; }
                },
                teamLogoUrl(name) {
                    const s = this.teamSlug(name);
                    const n = s.replace(/-/g, ''); // normalizado sem hífen
                    // Fallback automático para seleções nacionais (flags)
                    const countryMap = {
                        'brasil':'br','brazil':'br',
                        'argentina':'ar',
                        'venezuela':'ve',
                        'australia':'au','australiaw':'au',
                        'mexico':'mx','méxico':'mx',
                        'portugal':'pt',
                        'espanha':'es','spain':'es',
                        'franca':'fr','france':'fr',
                        'italia':'it','italy':'it',
                        'alemanha':'de','germany':'de',
                        'inglaterra':'gb-eng','england':'gb-eng',
                        'estadosunidos':'us','eua':'us','usa':'us','unitedstates':'us',
                        'japao':'jp','japan':'jp',
                        'coreiadosul':'kr','southkorea':'kr',
                        'uruguai':'uy','uruguay':'uy',
                        'paraguai':'py','paraguay':'py',
                        'chile':'cl',
                        'colombia':'co',
                        'peru':'pe',
                        'equador':'ec','ecuador':'ec',
                        'bolivia':'bo','bolívia':'bo',
                        'venezuela':'ve',
                        'canada':'ca','canadá':'ca',
                        'granada':'gd',
                        'ilhasvirgenseua':'vi','virginislandsus':'vi'
                    };
                    if (countryMap[n]) {
                        const code = countryMap[n];
                        return 'https://flagcdn.com/24x18/' + code + '.png';
                    }
                    return s ? ('img/teams/' + s + '.png') : '';
                },
                onLogoError(ev) {
                    try { if (ev && ev.target) ev.target.style.display = 'none'; } catch (e) {}
                },
                onPaisChange() {
                    const qs = new URLSearchParams(window.location.search || '');
                    if (this.findPais && this.findPais !== '*') {
                        qs.set('pais', this.findPais);
                        this.somenteBrasil = (this.findPais + '').toUpperCase() === 'BR';
                    } else {
                        qs.delete('pais');
                        this.somenteBrasil = false;
                    }
                    const newQuery = qs.toString();
                    const newUrl = window.location.pathname + (newQuery ? '?' + newQuery : '');
                    window.location.assign(newUrl);
                },
                onToggleBrasil() {
                    const qs = new URLSearchParams(window.location.search || '');
                    if (this.somenteBrasil) {
                        this.findPais = 'BR';
                        qs.set('pais', 'BR');
                    } else {
                        this.findPais = '*';
                        qs.delete('pais');
                    }
                    const newQuery = qs.toString();
                    const newUrl = window.location.pathname + (newQuery ? '?' + newQuery : '');
                    window.location.assign(newUrl);
                },
                gerarProximos7Dias() {
                    const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
                    const hoje = new Date();
                    
                    // Apenas 3 dias: HOJE, AMANHÃ, DEPOIS DE AMANHÃ
                    for (let i = 0; i < 3; i++) {
                        const data = new Date(hoje);
                        data.setDate(hoje.getDate() + i);
                        
                        const dia = String(data.getDate()).padStart(2, '0');
                        const mes = String(data.getMonth() + 1).padStart(2, '0');
                        const ano = data.getFullYear();
                        
                        this.datasProximos7Dias.push({
                            diaSemana: diasSemana[data.getDay()],
                            formatada: `${dia}/${mes}/${ano}`,
                            valor: `${ano}-${mes}-${dia}`
                        });
                    }
                },
                onAuth() {
                    $("html").addClass('page-loading');
                    axios
                        .post('entrar/login/insert', this.auth)
                        .then((response) => {
                            if (response.data.result == 1) {
                                window.location.reload();
                            } else {
                                $('html').removeClass('page-loading');
                                window.alert(response.data.message);
                            }
                        })
                        .then(() => {

                        })
                        .catch((err) => {
                            alert('Não foi possível acessar');
                            $('html').removeClas('page-loading');
                        });
                },
                getCotacao() {

                    var cotacao = 1;

                    this.aposta.jogos
                        .forEach((v) => {
                            cotacao *= v.jogo.cotacoes[v.tempo][v.cotacao.campo];
                        });

                    return parseFloat(Math.min(cotacao, this.cotacaoMaxima));

                },
                getCotacaoMinima() {
                    var cotacaoMinima = this.cotacaoMinima;
                    var valorAposta = this.valorAposta;
                    this.condicaoCotacao.forEach((value, index) => {
                        if ((value.min > 0 || value.max > 0) && value.cotacao > 0) {
                            if (value.min <= valorAposta && value.max >= valorAposta) {
                                cotacaoMinima = value.cotacao;
                            }
                        }
                    });
                    return cotacaoMinima;
                },
                getPremio() {
                    var valorAposta = this.valorAposta;
                    var cotacao = this.getCotacao();
                    if (cotacao > 1) {
                        return Math.min(valorAposta * cotacao, this.retornoMaximo);
                    } else {
                        return 0;
                    }
                },
                getCotacoesPrincipais() {
                    // Sempre exibe 1X2 como colunas principais.
                    return [
                        { campo: 'casa', title: 'Casa', principal: '1' },
                        { campo: 'empate', title: 'Empate', principal: '1' },
                        { campo: 'fora', title: 'Fora', principal: '1' },
                    ];
                },
                has1x2(jogo) {
                    try {
                        const odds = (jogo && jogo.cotacoes && jogo.cotacoes['90']) || {};
                        const casa = parseFloat(odds.casa);
                        const empate = parseFloat(odds.empate);
                        const fora = parseFloat(odds.fora);
                        return casa > 1 && empate > 1 && fora > 1;
                    } catch (e) { return false; }
                },
                // Conta quantas cotações configuradas existem para um determinado período do jogo
                countMappedForTempo(jogo, tempo) {
                    try {
                        const odds = (jogo && jogo.cotacoes && jogo.cotacoes[tempo]) || {};
                        let total = 0;
                        (this.cotacoes || []).forEach((c) => {
                            // só conta mercados não-principais (evita 1X2)
                            if (c && c.principal != '1') {
                                const v = odds[c.campo];
                                if (v && v > 1) total++;
                            }
                        });
                        return total;
                    } catch (e) {
                        return 0;
                    }
                },
                listPlacarExato() {
                    try {
                        const tempo = this.mJogo.tempo + '';
                        const odds = (this.mJogo.jogo && this.mJogo.jogo.cotacoes && this.mJogo.jogo.cotacoes[tempo]) || {};
                        const items = [];
                        const rex = /^cs_(\d+)_(\d+)$/;
                        Object.keys(odds).forEach((campo) => {
                            const v = odds[campo];
                            if (v <= 1) return;
                            const m = campo.match(rex);
                            if (!m) return;
                            const h = parseInt(m[1], 10), a = parseInt(m[2], 10);
                            items.push({
                                campo,
                                title: `Resultado exato ${h}:${a}`,
                                sigla: `CS ${h}:${a}`
                            });
                        });
                        items.sort((a,b) => {
                            const [ah,aa] = a.campo.replace('cs_','').split('_').map(n=>parseInt(n,10));
                            const [bh,ba] = b.campo.replace('cs_','').split('_').map(n=>parseInt(n,10));
                            if (ah === bh) return aa - ba;
                            return ah - bh;
                        });
                        return items;
                    } catch (e) { return []; }
                },
                outrosCount(jogo) {
                    try {
                        if (!jogo) return '';
                        // usa valor em cache, se já calculado via prefetch
                        if (typeof jogo._outrosCount !== 'undefined') {
                            const n = parseInt(jogo._outrosCount, 10);
                            return n > 0 ? String(n) : '';
                        }
                        const tempo = '90';
                        const odds = (jogo.cotacoes && jogo.cotacoes[tempo]) || {};
                        let count = 0;
                        // conta mercados oficiais (exceto 1X2) já disponíveis em 90'
                        (this.cotacoes || []).
                          forEach((c) => {
                            if (c && c.principal != '1') {
                              const v = odds[c.campo];
                              if (v && v > 1) count++;
                            }
                          });
                        // adiciona linhas de placar exato já presentes
                        Object.keys(odds).forEach((k) => {
                            if (/^cs_\d+_\d+$/.test(k) && odds[k] > 1) count++;
                        });
                        // retorna apenas número inteiro
                        return String(Math.max(0, parseInt(count, 10) || 0));
                    } catch (e) { return ''; }
                },
                // Busca as odds estendidas e calcula o count, sem abrir modal
                ensureOutrosCount(jogo) {
                    if (!jogo) return;
                    if (typeof jogo._outrosCount === 'number') return;
                    if (jogo._loadingOutros) return;
                    this.prefetchOutrosRemote(jogo);
                },
                prefetchOutros(jogo) {
                    try {
                        if (!jogo) return;
                        if (jogo._loadingOutros) return;
                        this.$set(jogo, '_loadingOutros', true);
                        // Calcula localmente a quantidade de "outras cotações" usando apenas dados já carregados
                        const tempo = '90';
                        const odds = (jogo.cotacoes && jogo.cotacoes[tempo]) || {};
                        let count = 0;
                        (this.cotacoes || []).forEach((c) => {
                            if (c && c.principal != '1') {
                                const v = odds[c.campo];
                                if (v && v > 1) count++;
                            }
                        });
                        Object.keys(odds).forEach((k) => {
                            if (/^cs_\d+_\d+$/.test(k) && odds[k] > 1) count++;
                        });
                        this.$set(jogo, '_outrosCount', Math.max(0, parseInt(count, 10) || 0));
                        this.$set(jogo, '_loadingOutros', false);
                    } catch (err) {
                        // evita quebra do render por erro
                        console.error('prefetchOutros error', err);
                        this.$set(jogo, '_loading', false);
                    }
                },
                // Fila controlada para buscar odds de alguns jogos por vez e popular _outrosCount
                queueOutrosCounts() {
                    const jogos = this.coletarJogos().filter(j => j && typeof j._outrosCount !== 'number');
                    const maxPrefetch = 24; // limita total por página
                    const concurrency = 4;  // limita concorrência
                    const fila = jogos.slice(0, maxPrefetch);
                    let idx = 0;
                    const proximo = () => {
                        if (idx >= fila.length) return Promise.resolve();
                        const atual = fila[idx++];
                        return this.prefetchOutrosRemote(atual).then(proximo);
                    };
                    // inicia N workers
                    const workers = [];
                    for (let i = 0; i < concurrency; i++) {
                        workers.push(proximo());
                    }
                    Promise.all(workers).catch(() => {});
                },
                // Busca remota (1 jogo) e computa o contador com base nas odds retornadas
                prefetchOutrosRemote(jogo) {
                    try {
                        if (!jogo || !jogo.id) return Promise.resolve();
                        if (jogo._loadingOutros) return Promise.resolve();
                        this.$set(jogo, '_loadingOutros', true);
                        const params = new URLSearchParams({ jogo: jogo.id });
                        return axios.get(url('apostar/odds') + '?' + params.toString())
                            .then(({ data }) => {
                                const live = (data && data.cotacoes) || {};
                                if (!jogo.cotacoes || typeof jogo.cotacoes !== 'object') {
                                    this.$set(jogo, 'cotacoes', {});
                                }
                                Object.keys(live).forEach((tempo) => {
                                    if (!jogo.cotacoes[tempo] || typeof jogo.cotacoes[tempo] !== 'object') {
                                        this.$set(jogo.cotacoes, tempo, {});
                                    }
                                    const mercados = live[tempo] || {};
                                    Object.keys(mercados).forEach((campo) => {
                                        this.$set(jogo.cotacoes[tempo], campo, mercados[campo]);
                                    });
                                });
                                // calcula count em 90'
                                const tempo = '90';
                                const odds = (jogo.cotacoes && jogo.cotacoes[tempo]) || {};
                                let count = 0;
                                (this.cotacoes || []).forEach((c) => {
                                    if (c && c.principal != '1') {
                                        const v = odds[c.campo];
                                        if (v && v > 1) count++;
                                    }
                                });
                                Object.keys(odds).forEach((k) => {
                                    if (/^cs_\d+_\d+$/.test(k) && odds[k] > 1) count++;
                                });
                                this.$set(jogo, '_outrosCount', count);
                            })
                            .catch(() => {})
                            .finally(() => {
                                this.$set(jogo, '_loadingOutros', false);
                            });
                    } catch (err) {
                        this.$set(jogo, '_loadingOutros', false);
                        return Promise.resolve();
                    }
                },
                getPaises() {
                    var paises = [];
                    this.paises.forEach((pais) => {
                        if (this.filterPais(pais)) {
                            paises.push(pais);
                        }
                    });
                    return paises;
                },
                getCampeonatos(pais, enableFilter) {
                    var campeonatos = [];
                    if (pais) {
                        pais.campeonatos.forEach((c) => {
                            if (enableFilter === false || this.filterCampeonato(c)) {
                                campeonatos.push(c);
                            }
                        });
                    } else {
                        (enableFilter === false ? this.paises : this.getPaises()).forEach((p) => {
                            p.campeonatos.forEach((c) => {
                                if (enableFilter === false || this.filterCampeonato(c)) {
                                    campeonatos.push(c);
                                }
                            });
                        });
                    }
                    return campeonatos;
                },
                getJogos(campeonato) {
                    var jogos = [];
                    if (campeonato && campeonato.jogos && Array.isArray(campeonato.jogos)) {
                        campeonato.jogos.forEach((jogo) => {
                            if (jogo && this.filterJogo(jogo)) {
                                jogos.push(jogo);
                            }
                        });
                    }
                    return jogos;
                },
                checkFiltros() {
                    if (!this.findData) {
                        if (this.findPais == '*' && this.findCampeonato == '*') {
                            return false;
                        }
                    }
                    return true;
                },
                filterPais(pais) {
                    if (this.findPais == '*' || this.findPais == pais.id) {
                        if (this.getCampeonatos(pais, true).length > 0) {
                            return true;
                        }
                    }
                    return false;
                },
                filterCampeonato(campeonato) {
                    if (this.findCampeonato == '*' || this.findCampeonato == campeonato.id) {
                        if (this.getJogos(campeonato).length) {
                            return true;
                        }
                    }
                    return false;
                },
                filterJogo(jogo) {
                    if (!jogo || !jogo.casa || !jogo.fora || !jogo.dateTime) {
                        return false;
                    }
                    var dt = new Date;
                    var dtJogo = new Date(jogo.dateTime);
                    dt.setMinutes(dt.getMinutes() + {{ dados.getMinutosJogo() }});
                    if (dt.getTime() < dtJogo.getTime()) {
                        if (!this.findData || jogo.data == this.findData) {
                            var exp = new RegExp(this.search, 'i');
                            if (!this.search || jogo.casa.search(exp) !== -1 || jogo.fora.search(exp) !== -1) {
                                if (this.somenteComOdds && !jogo._temOdds) {
                                    return false;
                                }
                                return true;
                            }
                        }
                    }
                    return false;
                },
                toggleSomenteOdds() {
                    if (this.somenteComOdds) {
                        this.somenteComOdds = false;
                        return;
                    }
                    this.loadingOddsFilter = true;
                    const jogos = this.coletarJogos();
                    const base = url('apostar/odds') + '?debug=1&jogo=';
                    Promise.all(jogos.map((j) => {
                        return fetch(base + j.id)
                            .then(r => r.json())
                            .then(jresp => {
                                const d = jresp && jresp.debug ? jresp.debug : {};
                                j._temOdds = (d && ((d.prematch_count > 0) || (d.fallback_count > 0) || (d.summary_count > 0)));
                            })
                            .catch(() => { j._temOdds = false; });
                    })).then(() => {
                        this.somenteComOdds = true;
                        this.loadingOddsFilter = false;
                    });
                },
                coletarJogos() {
                    const jogos = [];
                    (this.paises || []).forEach(p => {
                        (p.campeonatos || []).forEach(c => {
                            (c.jogos || []).forEach(j => jogos.push(j));
                        });
                    });
                    return jogos;
                },
                setPais(pais) {
                    if (pais) {
                        this.findPais = pais.id;
                        this.findCampeonato = '*';
                    } else {
                        this.findPais = '*';
                    }
                    this.findData = null;
                },
                setCampeonato(campeonato) {
                    $('html').removeClass('show-menu show-filtros');
                    if (campeonato) {
                        this.findCampeonato = campeonato.id;
                        if (this.findPais != '*' && this.findPais != campeonato.pais) {
                            this.findPais = '*';
                        }
                    } else {
                        this.findCampeonato = '*';
                    }
                    this.findData = null;
                },
                setData(data) {
                    $('html').removeClass('show-menu show-filtros');
                    this.findCampeonato = '*';
                    this.findPais = '*';
                    this.findData = data;
                },
                maisCotacoes(jogo) {
                    this.mJogo.jogo = jogo;
                    this.mJogo.tempo = 90;

                    // Buscar odds em tempo real na API e mesclar nas cotações do jogo
                    const params = new URLSearchParams({ jogo: jogo.id });
                    axios
                        .get(url('apostar/odds') + '?' + params.toString())
                        .then((response) => {
                            const data = response.data || {};
                            const live = data.cotacoes || {};
                            if (!this.mJogo.jogo.cotacoes) this.mJogo.jogo.cotacoes = {};
                            Object.keys(live).forEach((tempo) => {
                                // Garante reatividade ao criar o período
                                if (!this.mJogo.jogo.cotacoes[tempo] || typeof this.mJogo.jogo.cotacoes[tempo] !== 'object') {
                                    this.$set(this.mJogo.jogo.cotacoes, tempo, {});
                                }
                                // Garante reatividade ao incluir cada mercado
                                const mercados = live[tempo] || {};
                                Object.keys(mercados).forEach((campo) => {
                                    this.$set(this.mJogo.jogo.cotacoes[tempo], campo, mercados[campo]);
                                });
                            });
                        })
                        .catch(() => {})
                        .then(() => {
                            $('#modal-cotacoes').modal("show");
                        });
                },
                apostar(jogo, tempo, cotacao) {

                    let apostaEm = tempo + cotacao.campo;

                    if (jogo.apostaEm) {

                        // Removendo jogo da aposta
                        this.aposta.jogos
                            .forEach((v, index) => {
                                if (v.jogo.id == jogo.id)
                                    this.aposta.jogos.splice(index, 1);
                            });

                        if (jogo.apostaEm === apostaEm) {
                            jogo.apostaEm = null;
                        } else {
                            jogo.apostaEm = null;
                            if (this.filterJogo(jogo))
                                this.apostar(jogo, tempo, cotacao);
                        }

                    } else {

                        if (this.cotacaoMaxima > 0 && this.getCotacao() == this.cotacaoMaxima) {
                            swal('Aviso!', 'Sua aposta já atingiu a cotação máxima.', 'warning');
                        } else {

                            this.aposta.jogos
                                .forEach((v, i) => {
                                    if (v.jogo.id == jogo.id || !this.filterJogo(v.jogo)) {
                                        this.aposta.jogos.splice(i, 1);
                                    }
                                });

                            jogo.apostaEm = apostaEm;

                            if (cotacao.principal == '1' && tempo == '90') {
                                jogo.outras = false;
                            } else {
                                jogo.outras = true;
                            }

                            this.aposta.jogos
                                .push({
                                    jogo: jogo,
                                    tempo: tempo,
                                    cotacao: cotacao,
                                });

                            $('#modal-cotacoes').modal("hide");

                        }
                    }

                },
                inArray(needle, haystack) {
                    var length = haystack.length;
                    for (var i = 0; i < length; i++) {
                        if (haystack[i] == needle) {
                            return i;
                        }
                    }
                    return -1;
                },
                rmAposta(index) {

                    var aposta = this.aposta.jogos[index];

                    if (aposta) {
                        aposta.jogo.apostaEm = null;
                        aposta.jogo.outras = false;
                        this.aposta.jogos.splice(index, 1);
                    }
                },
                limpaAposta() {
                    this.aposta.jogos.forEach((j) => {
                        j.jogo.apostaEm = null;
                        j.jogo.outras = false;
                    });
                    this.aposta.jogos = [];
                    $(".bilhete").removeClass('show');
                },
                imprimir(campeonato) {
                    if (campeonato) {
                        window.open(url('apostar/imprimirTabela') + '?campeonato=' + campeonato, '_blank');
                    } else {
                        window.open(url('apostar/imprimirTabela') + '?campeonato=' + (this.findCampeonato || null) + '&data=' + (this.findData || '') + '&search=' + (this.search || ''), '_blank');
                    }
                },
                finalizarAposta() {

                    var aposta = {
                        valor: this.valorAposta,
                        cliente: this.cliente,
                        telefone: this.telefone,
                        revendedor: this.revendedor,
                        jogos: [],
                    };

                    this.aposta.jogos.forEach((v, index) => {

                        var jogo = v.jogo;

                        aposta.jogos.push({
                            jogo: v.jogo.id,
                            tempo: v.tempo,
                            cotacao: v.cotacao.campo,
                        });

                    });

                    $('html').addClass('loading').removeClass('show-bilhete');

                    axios
                        .post(url('apostar/apostar'), aposta)
                        .then((response) => {

                            var e = response.data;

                            if (e.result == 1) {

                                this.limpaAposta();
                                this.valorAposta = this.apostaMinima;

                                window.localStorage.removeItem('apostaJogos');

                                if (e.codigo) {

                                    swal({
                                        title: $.trim(e.codigo.replace(/(.{3})/g, '$1 ')),
                                        text: 'Bilhete gerado com sucesso!\nProcure um dos nossos cambistas para validar o seu bilhete.',
                                        icon: 'success',
                                        button: {
                                            text: 'Compartilhar whatsapp',
                                            closeModal: true,
                                            value: {link: e.link, share: e.share},
                                        }
                                    })
                                        .then((e) => {
                                            window.open(e.share, '_blank');
                                        });

                                } else {

                                    swal('Sucesso', 'Aposta realizada com sucesso!', 'success');

                                }

                            } else {
                                swal('Aviso!', e.message, 'warning');
                            }
                        })
                        .catch((err) => {

                        })
                        .then(() => {
                            $('html').removeClass('loading');
                        });

                }
            }
        });

    </script>

{% endblock %}
